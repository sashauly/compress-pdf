name: PDM Python Application CI

on:
    push:
        branches: ["master"]
    pull_request:
        branches: ["master"]

permissions:
    contents: read

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            # 1. Setup PDM and Python
            - name: Set up PDM and Python
              # Use the official action for PDM
              uses: pdm-project/setup-pdm@v4
              with:
                  # Use a specific version, or omit to read from pyproject.toml
                  python-version: "3.10"
                  cache: true # Enable PDM cache for faster runs

            # 2. Install Dependencies
            - name: Install dependencies
              # 'pdm install --dev' installs all main and development dependencies (pytest, flake8)
              # You must ensure pytest and flake8 are listed in a dev-dependency group in pyproject.toml
              run: pdm install --dev --no-self

            # 3. Lint with flake8
            - name: Lint with flake8
              # 'pdm run' executes the command from the PDM environment
              run: |
                  # stop the build if there are Python syntax errors or undefined names
                  pdm run flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
                  # exit-zero treats all errors as warnings. The GitHub editor is 127 chars wide
                  pdm run flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

            # 4. Test with pytest
            - name: Test with pytest
              # 'pdm run' executes pytest from the PDM environment
              run: pdm run pytest
